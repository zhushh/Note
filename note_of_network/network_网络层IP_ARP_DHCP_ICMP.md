## 计算机网络——传输层

路由器
----
* 功能：
```
1.分组：
2.转发：通过路由表转发，如果路由表找不到，则使用默认路由（默认网关）；
```

路由算法
----
* 静态路由：网络管理员手工配置路由信息；
```
优点：简便、可靠；
```

* 动态路由：路由表项通过互联的路由器之间彼此交换信息，然后按照一定的算法优化出来；
```
优点：能改善网络的性能并有助于流量控制；
缺点：算法复杂时，会增加网络负担；
```

* 距离向量路由算法

* 链路状态路由算法

* 层次路由
```
网络规模扩大时，路由表信息太大，需要分层次；因特网将整个网络划分为许多较小的自治系统来自主管理本地系统；
因特网把路由选择协议分为两类：
（1）、内部网管协议（IGP），也称域内路由选择，具体协议有RIP和OSPF；
（2）、外部网关协议（EGP），也称域间路由选择，具体协议有BGP；
```

IPv4
----
* IPv4分组的格式

![](https://github.com/zhushh/Note/blob/master/img/ip_%E6%95%B0%E6%8D%AE%E6%8A%A5%E7%BB%93%E6%9E%84.jpg?raw=true)
```
版本：IP协议的版本，占4位
首部长度：IP数据报首部的长度，占4位（IP数据报首部最短为20字节，此时不使用任何选项字段）
总长度：指首部长度和数据之和的长度，占16位（因此数据报最大的长度为：2^16-1=65535字节）
标识、标志、片偏移：与IP数据报在数据链路层分片有关
首部校验和：用来校验IP数据报首部校验，注意在这只校验首部，不校验数据，占16位
生存时间TTL：指数据报在网络中可通过的路由器数的最大值，是分组在网络中的寿命，以确保分组不会永远在网络中循环；
协议：指出分组携带的是何种协议，以告知分组的数据部分应该交给传输层协议（如TCP），其中值6表示TCP，值17表示UDP；
源地址：表示发送方的IP地址；
目的地址：标识接收方的IP地址；

注意：
在IP数据报首部中有三个关于长度的标记，首部长度、总长度和片偏移，它们的基本单位分别为：4Bytes,1Bytes,8Bytes;
```

* IP数据报分片
```
最大传输单元（MTU）：链路层数据报能承载的最大数据量
当IP数据报总长度大于MTU时，需要对IP数据报进行分片，分片在目的地的网络层进行组装；
分片的时候，有效数据长度必须是8的倍数，例如：一个长4000字节的IP数据报（首部20字节，数据部分3980字节）到达一个
路由器，需要转发一条MTU为1500字节的链路上，意味着3980字节需要分配到3个独立的片中（每个片也是一个IP数据报）。
假定原始数据报的标识号为777，那么分成3个片如图所示，除了最后一个片外，其他所有片中的有效数据载荷都是8的倍数。
```

* 网络层转发分组的流程
```
```

IPv4地址与NAT
----
* 传统的IP地址的划分
```
IP地址 = {<网络号>, <主机号>}
总共有五类地址：
A类地址：1~126，前8位为网络号，后24位为主机号
B类地址：128~191，前16位为网络号，后16位主机号
C类地址：192~223，前24位为网络号，后8位主机号
D类地址：224~239，多播地址
E类地址：240~255，保留今后使用
```
注意：

(1).主机号全为0表示本网络本身，例如：202.98.174.0（C类地址，后8位全为0）

(2).主机号全为1表示本网络的广播地址，例如：202.98.174.255

(3).127.0.0.0网络保留作为环路自检（Loopback Test）地址，次地址表示任意主机本身，目的地址为环回地址的IP数据报不会出现在任何网络上；

(4).32位全为0，即0.0.0.0表示本网络上的本主机

(5).32位全为1，即255.255.255.255表示整个TCP/IP网络的广播地址

* 网络地址转换(NAT)
```
私有IP地址：用于LAN，局域网或企业内部自己使用的网络IP，是专用网络地址，也称可重用地址；
共用IP地址：用于WAN，互联网上面标识自己地址的IP地址，是公用地址；

划分给私有IP地址网段为：
A类：10.0.0.0~10.255.255.255
B类：172.16.0.0~172.31.255.255
C类：192.168.0.0~192.168.255.255

网络地址转换（NAT）：把专用网络地址转换为公用地址，从而对外隐藏了内部管理的IP地址；
NAT使用NAT转换表将本地网络转换成全球地址，或将全球地址转换成本地地址；
NAT转换表：{本地地址：端口} <=> {全球IP地址：端口}
NAT转换表可以使多个私有IP地址映射到同一个全球IP地址；
```
因特网中的所有路由器，对目的地址是私有地址的数据报一律不进行转发。这种采用私有IP地址的互联网称为专用互联网或本地互联网；

注意：

普通路由器在转发IP数据报的时候，不会改变其源地址和目的地址，而NAT路由器在转发IP数据报的时候，一定要更换其IP地址；

子网划分与子网掩码、CIDR
----
* 子网划分
```
IP地址 = {<网络号>, <子网号>, <主机号>}
(1).划分子网是一个单位内部的事情
(2).从主机号借用若干比特作为网络号
(3).从其他网络发送给本单位某个主机的IP数据报，仍然是根据IP数据报的目的网络号，先找到连接在本位单
网络号上的路由器；然后在收到IP数据报后，再按目的网络号和子网号找到目的子网，最后把数据报交付给主机；
```

* 子网掩码
```
子网掩码：一个与IP地址相对应的长32bit的二进制串；
因特网标准规定，所有网络都必须使用子网掩码，若没有子网掩码，则使用默认的子网掩码；
各类IP地址的默认子网掩码：
A类：255.0.0.0
B类：255.255.0.0
C类：255.255.255.0
子网网络地址：IP地址和其对应的子网掩码逐位取与（AND），得到的就是子网网络地址；
```

* 无类别域间路由CIDR
```
IP地址 = {<网络前缀>, <主机号>}
例如：
IP地址为128.14.32.5/20，即：
地址为：10000000 00001110 00100000 00000101 (128.14.32.5)
掩码为：11111111 11111111 11110000 00000000 (255.255.240.0)
网络前缀：1000000 00001110 00100000 00000000 (128.14.32.0)
```
路由聚合：将网络号前缀都相同的连续IP地址，组成CIDR地址块，可以表示很多地址。（有助于减少路由器之间的路由选择信息交换，从而提高网络性能）；

CIDR中的地址数为：2^N-2，N为主机号位数；主机号全为0是网络号，主机号全为1是本地广播地址；

最长前缀匹配：路由表应选择网络前缀最长匹配的路由作为下一跳；


ARP协议、DHCP协议和ICMP协议
----
* IP地址与硬件地址
```
IP地址：网络层使用的地址，放在IP数据报的首部；
硬件地址：数据链路层使用的地址（如MAC地址），放在MAC帧的首部；
```

* 地址解析协议ARP（Address Resolution Protocol）
```
用途：把IP地址映射到MAC地址；
工作原理：
当主机A欲向本局域网上的某个主机B发送IP数据报，就先在ARP高速缓存中查看有无主机B的IP地址；如有，查
出其对应的硬件地址，再将此硬件地址写入MAC帧，然后通过局域网将该MAC帧发往硬件地址；如果没有，就通
过使用目的MAC地址为FF-FF-FF-FF-FF-FF的帧来封装并广播ARP请求分组，可以使局域网内的所有主机收到
ARP请求；当主机B收到该ARP请求后，就会向主机A发出响应ARP分组，分组中包含主机B的IP地址与MAC地址
的映射关系，主机A收到后将此映射写入ARP高速缓存中，然后按照查询到的硬件地址发送MAC帧；

注意：
ARP工作在网络层；
```

* 动态主机配置协议DHCP
```
用途：用于给主机动态分配IP地址，提供了即插即用的机制；
工作原理：
它使用客户/服务器方式；需要IP地址的主机在启动时就向DHCP服务器广播发送发现报文，这时该主机就称
为DHCP的客户；本地网络上所有主机都能收到此广播报文，但只有DHCP服务器才回答此广播报文；DHCP服务
器先在其数据库中查找该计算机的配置信息，若找到，则返回找到信息；若找不到，则服务器的IP地址池中取
出一个地址分配给该计算机；DHCP服务器的回答报文叫做提供报文；

租用期：DHCP服务器分配给DHCP客户的IP地址是临时的，因此DHCP客户只能在一段时间内使用这个分配的IP地址；

注意：
DHCP工作在应用层，基于UDP实现；
```

* 网际控制报文协议ICMP
```
用途：用来允许主机或路由器报告差错和异常情况，提高IP数据报交付成功的机会；
分类：ICMP差错报文和ICMP询问报文；
常见应用：分组网间探测Ping（用来测试两个主机之间的连通性）和traceroute（用来跟踪分组经过的路由）；

注意：
ICMP是IP层协议；Ping工作在应用层，直接使用ICMP而没有使用TCP/UDP；traceroute工作在网络层；
```
